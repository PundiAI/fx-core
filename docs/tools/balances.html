<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>f(x)Core Module Balances</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
</head>
<body>
<div class="text-center">
    <h2>CurrentModule: <span id="currentModule"></span></h2>
    <ul class="list-group">
        <li class="list-group-item"><a href="balances.html?module=total">Query Total</a></li>
        <li class="list-group-item"><a href="balances.html">Query ERC20</a></li>
    </ul>
    <div class="row">
        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">BlockChain</th>
                <th scope="col">Symbol</th>
                <th scope="col">Balance</th>
            </tr>
            </thead>
            <tbody id="crosschain">
            </tbody>
        </table>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js"
        integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"
        integrity="sha384-ODmDIVzN+pFdexxHEHFBQH3/9/vQ9uori45z4JjnFsRydbmQbmL5t1tQ0culUzyK"
        crossorigin="anonymous"></script>
<script src="./js/bech32.js"></script>
<script src="./js/index.js"></script>
<script type="text/javascript">
    let module = getQueryVariable("module")
    let moduleAddress = "fx1glht96kr2rseywuvhhay894qw7ekuc4qs5z0yh"
    if (module === "total") {
        moduleAddress = "total"
    }

    const metadatas = getMetadatas()

    function getModuleBalances(moduleAddress) {
        let balances
        if (!moduleAddress) {
            balances = getTotalSupply()
        } else {
            balances = getBalances(moduleAddress)
        }
        return balances
    }

    function balancesSymbol(balances) {
        for (let i = 0; i < balances.length; i++) {
            for (let j = 0; j < metadatas.length; j++) {
                if (balances[i].denom === metadatas[j].base) {
                    balances[i].symbol = metadatas[j].symbol
                    let exponent = 18
                    if (balances[i].symbol !== "FX") {
                        exponent = metadatas[j].denom_units[1].exponent
                    }
                    balances[i].exponent = exponent
                }
                const aliases = metadatas[j].denom_units[0].aliases
                for (let k = 0; k < aliases.length; k++) {
                    if (balances[i].denom === aliases[k]) {
                        balances[i].symbol = metadatas[j].symbol
                        balances[i].exponent = metadatas[j].denom_units[1].exponent
                    }
                }
            }
        }
        return balances
    }

    document.querySelector("#currentModule").innerHTML = module === "total" ? "TotalSupply" : "ERC20"
    let balances = getModuleBalances(module === "total" ? "" : moduleAddress)
    balances = balancesSymbol(balances);
    balances.sort((a, b) => {
        return a.symbol.localeCompare(b.symbol)
    })
    let results = []
    for (let i = 0; i < balances.length; i++) {
        let balance = balances[i]
        let blockchain = "fxCore"
        let bridgeURL = "https://starscan.io"
        if (balance.denom.startsWith("eth")) {
            blockchain = "Ethereum"
            bridgeURL = "https://etherscan.com/address/0x6f1D09Fed11115d65E1071CD2109eDb300D80A27"
        }
        if (balance.denom.startsWith("bsc")) {
            blockchain = "BSC"
            bridgeURL = "https://bscscan.com/address/0x84238c00c8313920826D798e3cF6793Ef4F610ad"
        }
        if (balance.denom.startsWith("polygon")) {
            blockchain = "Polygon"
            bridgeURL = "https://polygonscan.com/address/0x4052eA614c5a96631C546d8B8d323a7C3D9ABb69"
        }
        if (balance.denom.startsWith("tron")) {
            blockchain = "Tron"
            bridgeURL = "https://tronscan.org/#/contract/TKLDunqAynYcXRktcYHqncp3R6nJeEXLd5"
        }
        if (balance.denom.startsWith("avalanche")) {
            blockchain = "Avalanche"
            bridgeURL = "https://snowtrace.io/address/0xDc3706d164d2D88b85ed702079ab331e2476D475"
        }
        if (balance.denom.startsWith("arbitrum")) {
            blockchain = "Arbitrum"
        }
        if (balance.denom.startsWith("optimism")) {
            blockchain = "Optimism"
        }
        if (balance.denom.startsWith("ibc")) {
            if (balance.symbol === "PURSE") {
                blockchain = "PUNDIX"
            } else {
                blockchain = "UNKNOWN"
            }
        }
        let exponent = balance.exponent
        let decimal = "1" + ("0".repeat(exponent - 2))
        results = results.concat({
            bridgeURL: bridgeURL,
            blockchain: blockchain,
            symbol: `${balance.symbol} [${balance.denom}]`,
            amount: `${(Number(BigInt(balance.amount) / BigInt(decimal)) / 100).toLocaleString()}`,
        })
    }
    const signBody = document.getElementById("crosschain")
    signBody.innerHTML = ''
    results.sort((a, b) => (a.blockchain > b.blockchain) ? 1 : -1)
    results.forEach((v, i) => {
        let para = document.createElement('tr');
        para.innerHTML = `
                <th scope="row">${i + 1}</th>
                <td style="text-align: left"><a href="${v.bridgeURL}">${v.blockchain}</a></td>
                <td style="text-align: left">${v.symbol}</td>
                <td style="text-align: left">${v.amount}</td>`
        signBody.appendChild(para)
    })
</script>
</body>
</html>